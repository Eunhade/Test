<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wordle Battle - Single Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #121213;
            color: #ffffff;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        h1, h2 {
            margin: 0.5em 0;
        }

        button {
            cursor: pointer;
        }

        a {
            color: #58a6ff;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background-color: #1f2933;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #374151;
            width: 80%;
            max-width: 500px;
            color: #ffffff;
        }

        .close-modal {
            float: right;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div style="position: relative; width: 100%; max-width: 800px; margin: 0 auto;">
        <div style="position: absolute; top: 0; left: 0;">
            <button id="back-button">Back</button>
        </div>
        <div style="position: absolute; top: 0; right: 0;">
            <button id="leaderboard-button" style="margin-right: 10px;">Leaderboard</button>
            <button id="stats-button">Stats</button>
            <button id="logout-button" style="margin-left: 10px;">Logout</button>
        </div>

        <div style="padding-top: 40px;">
            <h1>Wordle Battle</h1>
            <h2>Single Player Mode</h2>
            <p>Guess the 5-letter word. Green = correct spot, yellow = wrong spot, gray = not in the word.</p>

            <button id="new-game-button" style="font-size: 18px; padding: 10px 20px; margin-top: 10px;">
                New Game
            </button>

            <div id="singleplayer-game" style="margin-top: 30px;">
                <div style="margin-top: 15px;">
                    <input id="guess-input" type="text" maxlength="5"
                           style="font-size: 20px; text-transform: uppercase;">
                    <button id="guess-button" style="font-size: 18px; margin-left: 10px;">Guess</button>
                </div>
                <div id="game-message" style="margin-top: 15px; font-weight: bold;"></div>
                <div id="guesses-container" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <span id="close-stats" class="close-modal">&times;</span>
            <h2>Your Stats</h2>
            <p>Wins: <span id="wins-count">0</span></p>
            <p>Losses: <span id="losses-count">0</span></p>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="modal">
        <div class="modal-content">
            <span id="close-leaderboard" class="close-modal">&times;</span>
            <h2>Leaderboard</h2>
            <p>(Backend leaderboard endpoint can be added later.)</p>
            <table style="margin: 0 auto; border-collapse: collapse; width: 100%;">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Username</th>
                        <th>Wins</th>
                        <th>Losses</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr>
                        <td colspan="4">Coming soon...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Helper: refresh stats from /api/check-auth
        async function refreshStats() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                if (data.authenticated && data.user) {
                    document.getElementById('wins-count').textContent = data.user.wins;
                    document.getElementById('losses-count').textContent = data.user.losses;
                }
            } catch (err) {
                console.error('Failed to refresh stats', err);
            }
        }

        // Helper: render guesses into tiles
        function renderGuesses(guesses) {
            const container = document.getElementById('guesses-container');
            container.innerHTML = '';

            guesses.forEach(entry => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.justifyContent = 'center';
                row.style.marginTop = '5px';

                const letters = entry.guess.split('');
                entry.feedback.forEach((status, index) => {
                    const tile = document.createElement('div');
                    tile.textContent = letters[index] || '';
                    tile.style.width = '40px';
                    tile.style.height = '40px';
                    tile.style.display = 'flex';
                    tile.style.alignItems = 'center';
                    tile.style.justifyContent = 'center';
                    tile.style.margin = '2px';
                    tile.style.border = '1px solid #333';
                    tile.style.fontWeight = 'bold';

                    if (status === 'correct') {
                        tile.style.backgroundColor = '#6aaa64'; // green
                        tile.style.color = '#fff';
                    } else if (status === 'present') {
                        tile.style.backgroundColor = '#c9b458'; // yellow
                        tile.style.color = '#fff';
                    } else {
                        tile.style.backgroundColor = '#787c7e'; // gray
                        tile.style.color = '#fff';
                    }

                    row.appendChild(tile);
                });

                container.appendChild(row);
            });
        }

        // Helper: start a new single-player game
        async function startNewGame() {
            try {
                const response = await fetch('/api/new-game', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    alert(data.error || 'Failed to start new game');
                    return;
                }

                document.getElementById('game-message').textContent = 'New game started! Start guessing.';
                document.getElementById('guesses-container').innerHTML = '';
                const guessInput = document.getElementById('guess-input');
                guessInput.value = '';
                guessInput.focus();
            } catch (err) {
                alert('Error: Failed to connect to server');
                console.error('New game error:', err);
            }
        }

        // Helper: submit a guess
        async function submitGuess() {
            const input = document.getElementById('guess-input');
            const messageEl = document.getElementById('game-message');
            const guessRaw = input.value.trim();

            if (!guessRaw) return;

            try {
                const response = await fetch('/api/guess', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ guess: guessRaw })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    messageEl.textContent = data.error || 'Guess failed';
                    return;
                }

                renderGuesses(data.guesses);

                if (data.status === 'won') {
                    messageEl.textContent = `You won! The word was ${data.target}.`;
                    await refreshStats();
                } else if (data.status === 'lost') {
                    messageEl.textContent = `You lost! The word was ${data.target}.`;
                    await refreshStats();
                } else {
                    messageEl.textContent = 'Keep guessing...';
                }

                input.value = '';
                input.focus();
            } catch (err) {
                messageEl.textContent = 'Error: Failed to connect to server';
                console.error('Guess error:', err);
            }
        }

        // Buttons: back, logout, stats, leaderboard
        document.getElementById('back-button').addEventListener('click', function () {
            window.location.href = '/';
        });

        document.getElementById('logout-button').addEventListener('click', async function () {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    window.location.href = '/';
                }
            } catch (err) {
                console.error('Logout error:', err);
            }
        });

        document.getElementById('stats-button').addEventListener('click', async function () {
            await refreshStats();
            document.getElementById('stats-modal').style.display = 'block';
        });

        document.getElementById('close-stats').addEventListener('click', function () {
            document.getElementById('stats-modal').style.display = 'none';
        });

        // Handle leaderboard button
        document.getElementById('leaderboard-button').addEventListener('click', async function () {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            try {
                const response = await fetch('/api/leaderboard');
                const data = await response.json();

                if (!response.ok || !data.success) {
                    // Show a simple error row
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="3" style="padding: 10px;">Failed to load leaderboard</td>
                    `;
                    tbody.appendChild(row);
                } else if (!data.leaderboard || data.leaderboard.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="3" style="padding: 10px;">No players yet</td>
                    `;
                    tbody.appendChild(row);
                } else {
                    data.leaderboard.forEach(player => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px;">${player.rank}</td>
                            <td style="padding: 10px;">${player.username}</td>
                            <td style="padding: 10px;">${player.wins} / ${player.losses}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (err) {
                console.error('Leaderboard fetch error:', err);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="3" style="padding: 10px;">Error connecting to server</td>
                `;
                tbody.appendChild(row);
            }

            document.getElementById('leaderboard-modal').style.display = 'block';
        });

        document.getElementById('close-leaderboard').addEventListener('click', function () {
            document.getElementById('leaderboard-modal').style.display = 'none';
        });

        // Guess input handlers
        const guessInputEl = document.getElementById('guess-input');
        const guessButtonEl = document.getElementById('guess-button');
        const newGameButtonEl = document.getElementById('new-game-button');

        guessButtonEl.addEventListener('click', function () {
            submitGuess();
        });

        guessInputEl.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                submitGuess();
            }
        });

        newGameButtonEl.addEventListener('click', function () {
            startNewGame();
        });

        // On page load: ensure user is authenticated, then start a new game
        (async function initPage() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                if (!data.authenticated) {
                    // Not logged in -> back to main
                    window.location.href = '/';
                    return;
                }
                await refreshStats();
                await startNewGame();
            } catch (err) {
                console.error('init error:', err);
                window.location.href = '/';
            }
        })();
    </script>
</body>
</html>
